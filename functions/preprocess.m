function [su,si,mu,mi,mui,mask,rs,cs,ff]=preprocess(s)

[Un,In]=size(s);
mask=(s>0);
% mask1=mask;
rs=1:Un;
cs=1:In;

%%%%%%%%%%%%%%%%%%%%%%%%
kr=find(sum(mask,2)==0);   
kc=find(sum(mask)==0);     
rs(kr)=[];
cs(kc)=[];

as=s(rs,cs);
mask=mask(rs,cs);
[r,c]=size(as);
mi=sum(as)./sum(mask);           %sum(s.*mask)??è¡?????ï¼????©é?µç??????ï¼?mI??å¹³å??
mu=sum(as,2)./sum(mask,2);       %sum(s.*maskï¼?2)????????ï¼????©é?µç??è¡???ï¼?mUè¡?å¹³å??
mui=sum(sum(as.*mask))/sum(sum(mask)); %sum(sum(s.*mask))???©é?µç????????ç´???ï¼???????ç´?å¹³å??
su=(as-repmat(mu,1,c)).*mask;
si=(as-repmat(mi,r,1)).*mask;


ff=zeros(Un,In);
if ~isempty(kr)
    ff(kr,cs)=ff(kr,cs)+...
        repmat(mi,numel(kr),1);    %è¡???ä¸ºé?¶ç??è¡?ï¼??»æ????è¡?ä¸?????ä¸ºé?¶ç????å¯¹å???ä½?ç½?ï¼??¶ä???ç´??¨é?¨è¡¥??å¹³å??
end
if ~isempty(kc)
    ff(rs,kc)=ff(rs,kc)+...
        repmat(mu,1,numel(kc));    %????ä¸ºé?¶ç????ï¼??»æ??????ä¸?è¡???ä¸ºé?¶ç??è¡?å¯¹å???ä½?ç½?ï¼??¶ä???ç´??¨é?¨è¡¥è¡?å¹³å??
end
if ~isempty(kr) & ~isempty(kc)     %?©ä?è¡???ä¸ºé?¶ç??è¡???????ä¸ºé?¶ç????äº¤æ?¥ä?ç½?ï¼??¨é?¨è¡¥??????ç´???å¹³å??
    ff(kr,kc)=mui;
end